<!DOCTYPE html>
<html>
<head>
    <title>Nexus Root</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    <style>
        body {
            background-color: #000;
            color: #0f0;
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column-reverse; /* Puts terminal at the bottom */
            height: 100vh;
        }
        #game-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Allows clicks to go through to the game */
            z-index: 10;
        }
        #game-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none; /* Hidden by default */
        }
        #terminal {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #050505;
            padding: 10px;
            overflow-y: scroll;
            font-size: 16px;
        }
        .line {
            margin-bottom: 5px;
        }
        .prompt {
            color: #0f0;
        }
        #input-line {
            display: flex;
        }
        #input {
            background-color: transparent;
            border: none;
            color: #0f0;
            font-family: 'Courier New', Courier, monospace;
            font-size: 16px;
            flex-grow: 1;
        }
        #input:focus {
            outline: none;
        }
        .command-block {
            border: 1px solid #0f0;
            padding: 5px;
            margin-bottom: 10px;
            position: relative;
        }
        .copy-button {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #0f0;
            color: #000;
            border: none;
            cursor: pointer;
        }
        .man-page-viewer {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 600px;
            height: 70%;
            background-color: #050505;
            border: 2px solid #0f0;
            padding: 20px;
            overflow-y: scroll;
            z-index: 1000;
        }
        .man-page-viewer .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #0f0;
            color: #000;
            border: none;
            cursor: pointer;
        }
        #autocomplete {
            border: 1px solid #0f0;
            background-color: #050505;
            max-height: 150px;
            overflow-y: auto;
        }
        #autocomplete div {
            padding: 5px;
            cursor: pointer;
        }
        #autocomplete div:hover {
            background-color: #0f0;
            color: #000;
        }
        #mobile-ui-bar {
            display: flex;
            justify-content: space-around;
            padding: 5px;
            background-color: #050505;
        }
        #mobile-ui-bar button {
            background-color: #0f0;
            color: #000;
            border: none;
            font-size: 18px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="game-overlay">
        <div id="game-container"></div>
    </div>
    <div id="terminal">
        <div id="output">
            <div class="line">Welcome to Nexus Root. Type 'help' for a list of commands.</div>
        </div>
        <div id="mobile-ui-bar">
            <button onclick="toggleMapView()">Map</button>
            <button onclick="insertCommand('scan')">scan</button>
            <button onclick="insertCommand('connect')">connect</button>
            <button onclick="insertCommand('run')">run</button>
            <button onclick="insertChar('|')">|</button>
            <button onclick="insertChar('&')">&</button>
            <button onclick="insertChar('$')">$</button>
            <button onclick="moveCursor('left')">&lt;</button>
            <button onclick="moveCursor('right')">&gt;</button>
            <button onclick="commandHistory('up')">↑</button>
            <button onclick="commandHistory('down')">↓</button>
        </div>
        <div id="input-line">
            <span class="prompt">&gt; </span>
            <input type="text" id="input" autofocus>
            <div id="autocomplete"></div>
        </div>
    </div>

    <script src="scenes/MainMenuScene.js"></script>
    <script src="scenes/LanScene.js"></script>
    <script src="scenes/PvpScene.js"></script>
    <script src="scenes/SettingsScene.js"></script>
    <script src="scenes/IconFactory.js"></script>
    <script src="scenes/NotepadScene.js"></script>
    <script src="scenes/AccountScene.js"></script>
    <script src="scenes/PremiumScene.js"></script>
    <script src="scenes/VCStatusScene.js"></script>
    <script src="scenes/ShopScene.js"></script>
    <script src="main.js"></script>

    <script>
        // CLI Handling Logic
        const terminalOutput = document.getElementById('output');
        const terminalInput = document.getElementById('input');
        let sessionToken = null; // Will be set on login
        let playerName = 'test_user'; // Should be set on login
        const autocompleteContainer = document.getElementById('autocomplete');
        const availableCommands = ["help", "man", "ls", "cat", "scan", "connect", "run", "shop", "buy"]; // Will be fetched

        terminalInput.addEventListener('input', () => {
            const text = terminalInput.value;
            if (text.length === 0) {
                autocompleteContainer.style.display = 'none';
                return;
            }
            const suggestions = availableCommands.filter(cmd => cmd.startsWith(text));
            if (suggestions.length > 0) {
                autocompleteContainer.innerHTML = '';
                suggestions.forEach(s => {
                    const div = document.createElement('div');
                    div.textContent = s;
                    div.onclick = () => {
                        terminalInput.value = s;
                        autocompleteContainer.style.display = 'none';
                    };
                    autocompleteContainer.appendChild(div);
                });
                autocompleteContainer.style.display = 'block';
            } else {
                autocompleteContainer.style.display = 'none';
            }
        });

        terminalInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const command = terminalInput.value;
                terminalInput.value = '';
                autocompleteContainer.style.display = 'none';
                executeCommand(command);
            }
        });

        async function executeCommand(command) {
            commandHistory.unshift(command);
            historyIndex = -1;

            if (command.trim().startsWith('man')) {
                showManPage(command);
                return;
            }

            const commandBlock = document.createElement('div');
            commandBlock.classList.add('command-block');

            const commandLine = document.createElement('div');
            commandLine.classList.add('line');
            commandLine.innerHTML = `<span class="prompt">&gt; </span>${command}`;
            commandBlock.appendChild(commandLine);

            const response = await fetch('/api/command/execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${sessionToken}`
                },
                body: JSON.stringify({ command, player_name: playerName })
            });
            const data = await response.json();
            const responseLine = document.createElement('div');
            responseLine.classList.add('line');

            if (data.success) {
                responseLine.textContent = data.output;
                window.dispatchEvent(new CustomEvent('commandSuccess', { detail: data }));
                // Dispatch resource update event
                window.dispatchEvent(new CustomEvent('updateResources', { detail: { cpu: Math.random() * 100, ram: Math.random() * 100, credits: 100 } }));
                if (navigator.vibrate) {
                    navigator.vibrate(100); // Vibrate for 100ms
                }

                const copyButton = document.createElement('button');
                copyButton.textContent = 'Copy';
                copyButton.classList.add('copy-button');
                copyButton.addEventListener('click', () => {
                    navigator.clipboard.writeText(data.output);
                });
                commandBlock.appendChild(copyButton);

            } else {
                responseLine.textContent = `Error: ${data.error}`;
            }
            commandBlock.appendChild(responseLine);
            terminalOutput.appendChild(commandBlock);
            document.getElementById('terminal').scrollTop = document.getElementById('terminal').scrollHeight;
        }

        function showManPage(command) {
            // This is a simplified implementation. A real one would fetch help text.
            const manPageContent = `
                <h2>NAME</h2>
                <p><b>${command.split(' ')[1]}</b> - A NexusScript command</p>
                <h2>DESCRIPTION</h2>
                <p>This is a placeholder for the manual page. In a real implementation, this content would be fetched from the server.</p>
            `;

            const viewer = document.createElement('div');
            viewer.classList.add('man-page-viewer');
            viewer.innerHTML = manPageContent;

            const closeButton = document.createElement('button');
            closeButton.textContent = 'Close';
            closeButton.classList.add('close-button');
            closeButton.addEventListener('click', () => {
                document.body.removeChild(viewer);
            });
            viewer.appendChild(closeButton);

            document.body.appendChild(viewer);
        }

        function toggleMapView() {
            const gameContainer = document.getElementById('game-container');
            const terminal = document.getElementById('terminal');
            if (gameContainer.style.display === 'none' || gameContainer.style.display === '') {
                gameContainer.style.display = 'block';
                terminal.style.display = 'none';
                if (game && !game.isBooted) {
                    game.boot();
                }
            } else {
                gameContainer.style.display = 'none';
                terminal.style.display = 'flex';
            }
        }

        function insertCommand(command) {
            const input = document.getElementById('input');
            input.value = command + ' ';
            input.focus();
        }

        function insertChar(char) {
            const input = document.getElementById('input');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            input.value = input.value.substring(0, start) + char + input.value.substring(end);
            input.selectionStart = input.selectionEnd = start + 1;
        }

        function moveCursor(direction) {
            const input = document.getElementById('input');
            if (direction === 'left') {
                input.selectionStart = input.selectionEnd = Math.max(0, input.selectionStart - 1);
            } else {
                input.selectionStart = input.selectionEnd = Math.min(input.value.length, input.selectionStart + 1);
            }
        }

        let commandHistory = [];
        let historyIndex = -1;
        function commandHistory(direction) {
            if (direction === 'up') {
                if (historyIndex < commandHistory.length - 1) {
                    historyIndex++;
                    document.getElementById('input').value = commandHistory[historyIndex];
                }
            } else {
                if (historyIndex > 0) {
                    historyIndex--;
                    document.getElementById('input').value = commandHistory[historyIndex];
                } else {
                    historyIndex = -1;
                    document.getElementById('input').value = '';
                }
            }
        }
    </script>
</body>
</html>
